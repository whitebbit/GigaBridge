# –†–µ–∑—é–º–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Redis –∏ APScheduler

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### 1. Redis Infrastructure
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω Redis –≤ `docker-compose.yml` —Å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
- ‚úÖ –°–æ–∑–¥–∞–Ω `core/storage.py` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redis storage –¥–ª—è FSM
- ‚úÖ –°–æ–∑–¥–∞–Ω `utils/cache.py` –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `core/loader.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Redis FSM storage
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redis –≤ `core/config.py`

### 2. APScheduler Infrastructure
- ‚úÖ –°–æ–∑–¥–∞–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å `services/scheduler.py`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `services/subscription_checker.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `main.py` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

### 3. Payment Checking —á–µ—Ä–µ–∑ APScheduler
- ‚úÖ –°–æ–∑–¥–∞–Ω `services/payment_checker.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ –î–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–µ–π —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ —Å `asyncio.create_task` –Ω–∞ APScheduler
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `handlers/buy/payment.py` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

## üìã –ß—Ç–æ –µ—â–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `utils/db.py`:
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ–∫–∞—Ü–∏–π
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö

### 2. –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
–°–æ–∑–¥–∞—Ç—å `services/subscription_reminders.py`:
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 3 –¥–Ω—è –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 1 –¥–µ–Ω—å –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –¥–µ–Ω—å –∏—Å—Ç–µ—á–µ–Ω–∏—è

### 3. Rate Limiting
–°–æ–∑–¥–∞—Ç—å `middlewares/rate_limit.py`:
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫ –æ–ø–ª–∞—Ç—ã
- –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ø–∞–º–∞

### 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Hiddify
–°–æ–∑–¥–∞—Ç—å `services/hiddify_sync.py`:
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ–¥–ø–∏—Å–æ–∫
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ —Ç—Ä–∞—Ñ–∏–∫–µ

### 5. –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
–°–æ–∑–¥–∞—Ç—å `services/cleanup.py`:
- –û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–µ–∫—à–∏—Ö FSM —Å–æ—Å—Ç–æ—è–Ω–∏–π
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫—ç—à–µ–π
- –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### –ó–∞–ø—É—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞
```bash
docker compose up -d
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Redis
```bash
docker exec -it gigabridge_redis redis-cli
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–¥–∞—á APScheduler
–í –ª–æ–≥–∞—Ö –±–æ—Ç–∞ –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏.

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **FSM Storage**: –í—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Redis, —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤.

2. **Payment Checking**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ APScheduler –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥, —á—Ç–æ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —á–µ–º —Ü–∏–∫–ª `while` —Å `asyncio.sleep`.

3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–∞, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ë–î.

4. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫**: –í—Å–µ –∑–∞–¥–∞—á–∏ —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å `services/scheduler.py`.

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
```env
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
```

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Redis
- **DB 0**: FSM Storage (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è aiogram)
- **DB 1**: Cache (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è)
- **DB 2**: Rate Limiting (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è rate limiting)

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- `docs/REDIS_APSCHEDULER_INTEGRATION.md` - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

