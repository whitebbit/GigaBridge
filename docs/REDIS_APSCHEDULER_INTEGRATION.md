# Интеграция Redis и APScheduler

## Обзор

Этот документ описывает архитектуру интеграции Redis и APScheduler в проект GigaBridge для улучшения производительности, масштабируемости и автоматизации.

## Redis - Использование

### 1. FSM Storage (Finite State Machine)
**Место:** `core/storage.py`
**Назначение:** Хранение состояний FSM для пользователей
**Преимущества:**
- Персистентность состояний между перезапусками
- Возможность масштабирования на несколько инстансов бота
- Автоматическая очистка истекших состояний

**Использование:**
- Все FSMContext будут храниться в Redis
- TTL для состояний: 1 час (автоматическая очистка)

### 2. Кэширование данных
**Место:** `utils/cache.py`
**Назначение:** Кэширование часто запрашиваемых данных
**Кэшируемые данные:**
- Список активных локаций (TTL: 5 минут)
- Список активных серверов (TTL: 5 минут)
- Информация о пользователе (TTL: 10 минут)
- Информация о подписках пользователя (TTL: 2 минуты)

**Преимущества:**
- Снижение нагрузки на PostgreSQL
- Ускорение ответов бота
- Меньше запросов к БД

### 3. Временное хранение данных платежей
**Место:** `services/payment_storage.py`
**Назначение:** Хранение данных о платежах во время проверки статуса
**Использование:**
- Хранение payment_id, yookassa_payment_id, user_id, server_id
- TTL: 30 минут (время проверки платежа)
- Используется APScheduler для проверки статуса

### 4. Rate Limiting
**Место:** `middlewares/rate_limit.py`
**Назначение:** Защита от спама и злоупотреблений
**Реализация:**
- Ограничение количества сообщений от пользователя (10 сообщений в минуту)
- Ограничение количества попыток оплаты (3 попытки в 5 минут)
- Ограничение количества запросов к API (100 запросов в минуту)

### 5. Сессии пользователей
**Место:** `utils/session.py`
**Назначение:** Хранение временных данных сессии
**Использование:**
- Последние действия пользователя
- Временные настройки
- История взаимодействий

## APScheduler - Использование

### 1. Централизованный планировщик
**Место:** `services/scheduler.py`
**Назначение:** Единая точка управления всеми задачами
**Преимущества:**
- Централизованное управление
- Легкое добавление новых задач
- Мониторинг выполнения задач

### 2. Проверка статуса платежей
**Текущая проблема:** Используется `asyncio.create_task` с циклом `while`, что неэффективно
**Решение:** Использовать APScheduler для периодической проверки
**Реализация:**
- Задача запускается каждые 10 секунд для каждого платежа
- Автоматически удаляется после завершения или истечения времени
- Максимальное время проверки: 5 минут

### 3. Напоминания о скором истечении подписки
**Место:** `services/subscription_reminders.py`
**Назначение:** Уведомления пользователям о скором истечении подписки
**Реализация:**
- Проверка каждый день в 09:00 UTC
- Уведомления за 3 дня до истечения
- Уведомления за 1 день до истечения
- Уведомление в день истечения

### 4. Проверка истекших подписок
**Текущее:** Уже реализовано в `services/subscription_checker.py`
**Улучшение:** 
- Добавить более частую проверку (каждые 6 часов)
- Добавить уведомления пользователям об истечении

### 5. Периодическая синхронизация с Hiddify API
**Место:** `services/hiddify_sync.py`
**Назначение:** Синхронизация данных о подписках с Hiddify
**Реализация:**
- Проверка каждые 30 минут
- Обновление статусов подписок
- Обновление данных о трафике

### 6. Очистка старых данных
**Место:** `services/cleanup.py`
**Назначение:** Очистка устаревших данных
**Реализация:**
- Очистка истекших FSM состояний (каждый час)
- Очистка старых кэшей (каждый день)
- Очистка старых данных платежей (каждую неделю)

## Архитектура

```
┌─────────────────┐
│   Telegram Bot  │
└────────┬─────────┘
         │
         ├─────────────────┐
         │                 │
    ┌────▼─────┐    ┌──────▼──────┐
    │  Redis   │    │ PostgreSQL  │
    │          │    │             │
    │ - FSM    │    │ - Users     │
    │ - Cache  │    │ - Payments  │
    │ - Rate   │    │ - Subscr.   │
    │   Limit  │    │ - Servers   │
    └────┬─────┘    └──────┬──────┘
         │                 │
         └─────────┬────────┘
                   │
            ┌──────▼──────┐
            │ APScheduler │
            │            │
            │ - Payments │
            │ - Reminders│
            │ - Cleanup  │
            │ - Sync     │
            └────────────┘
```

## Порядок внедрения

1. **Этап 1: Redis для FSM Storage**
   - Настройка Redis в docker-compose
   - Создание Redis storage для FSM
   - Обновление core/loader.py

2. **Этап 2: Кэширование**
   - Создание utils/cache.py
   - Интеграция кэширования в utils/db.py
   - Обновление handlers для использования кэша

3. **Этап 3: Централизованный APScheduler**
   - Создание services/scheduler.py
   - Перенос существующих задач
   - Обновление main.py

4. **Этап 4: Проверка платежей через APScheduler**
   - Удаление asyncio.create_task
   - Создание задач через APScheduler
   - Хранение данных в Redis

5. **Этап 5: Дополнительные задачи**
   - Напоминания о подписках
   - Синхронизация с Hiddify
   - Очистка данных

6. **Этап 6: Rate Limiting**
   - Создание middleware
   - Интеграция в handlers

## Преимущества

1. **Производительность:**
   - Быстрый доступ к данным через Redis
   - Меньше нагрузки на PostgreSQL
   - Кэширование частых запросов

2. **Масштабируемость:**
   - Возможность запуска нескольких инстансов бота
   - Общий FSM storage в Redis
   - Централизованные задачи в APScheduler

3. **Надежность:**
   - Персистентность состояний
   - Автоматическая очистка данных
   - Мониторинг задач

4. **Автоматизация:**
   - Автоматические напоминания
   - Автоматическая проверка платежей
   - Автоматическая синхронизация

## Конфигурация

### Redis
- Host: redis (в Docker) или localhost
- Port: 6379
- DB: 0 (FSM), 1 (Cache), 2 (Rate Limit)

### APScheduler
- Timezone: UTC
- Job Store: Memory (можно расширить до Redis)
- Executor: AsyncIOExecutor

