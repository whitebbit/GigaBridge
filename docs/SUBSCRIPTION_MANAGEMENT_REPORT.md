# Отчет: Реализация управления временем подписки через API

## Дата: 2025-11-28

## Обзор изменений

Реализована полная система управления временем подписки через 3x-ui API. Бот теперь самостоятельно отслеживает срок действия подписок и управляет включением/отключением клиентов на серверах через API, вместо того чтобы полагаться на встроенное время истечения в 3x-ui.

## Принятое решение

**Выбранный подход:** Бот самостоятельно управляет включением/отключением клиентов через API на основе данных из базы данных.

**Преимущества:**
- Централизованное управление подписками через БД
- Гибкость в продлении подписок
- Возможность синхронизации состояния между БД и сервером
- Легкое добавление уведомлений пользователям
- Возможность ручного управления подписками через админ-панель

## Реализованные изменения

### 1. Изменение создания клиента (`services/x3ui_api.py`)

**Было:**
- При создании клиента задавалось `expiryTime` на основе количества дней подписки
- Сервер сам отключал клиента после истечения времени

**Стало:**
- При создании клиента `expiryTime` устанавливается в `0` (бессрочная подписка)
- Управление включением/отключением полностью контролируется ботом через API

```python
# НЕ задаем expiryTime - бот сам управляет включением/отключением клиента
# Используем 0 для бессрочной подписки (управление через enable/disable)
x_time = 0  # Бессрочная подписка, управление через enable/disable
```

### 2. Добавлены методы управления клиентами (`services/x3ui_api.py`)

#### `update_client(client_email, enable=None, days=None)`
- Обновляет клиента (включение/отключение или продление)
- Параметры:
  - `enable`: Включить (True) или отключить (False) клиента
  - `days`: Количество дней для продления (опционально)
- При продлении автоматически включает клиента

#### `enable_client(client_email)`
- Включает клиента на сервере
- Удобный метод-обертка для `update_client(client_email, enable=True)`

#### `disable_client(client_email)`
- Отключает клиента на сервере
- Удобный метод-обертка для `update_client(client_email, enable=False)`

**Особенности реализации:**
- Методы получают текущие данные клиента из inbound
- Обновляют только необходимые поля
- Сохраняют остальные настройки клиента без изменений
- Обрабатывают ошибки и возвращают понятные сообщения

### 3. Обновлен сервис проверки подписок (`services/subscription_checker.py`)

**Новая логика:**
1. **Проверка активных подписок:**
   - Если подписка истекла → отключает клиента на сервере через API и обновляет статус в БД на "expired"
   - Если подписка активна → включает клиента на сервере через API (на случай, если он был отключен)

2. **Проверка истекших подписок:**
   - Убеждается, что все истекшие подписки отключены на сервере

**Расписание проверки:**
- Ежедневно в 00:00 UTC
- Каждые 6 часов

**Логирование:**
- Подробные логи всех операций
- Счетчики включенных/отключенных подписок
- Обработка ошибок с детальными сообщениями

### 4. Обновлена логика продления подписки (`handlers/buy/payment.py`)

**При продлении подписки:**
1. Обновляется срок действия в БД
2. Статус подписки устанавливается в "active"
3. **Автоматически включается клиент на сервере через API**
4. При необходимости продлевается время (если используется)

**Код:**
```python
# Включаем клиента на сервере через API при продлении
if subscription.x3ui_client_email and subscription.server_id:
    renewal_server = await get_server_by_id(subscription.server_id)
    if renewal_server:
        x3ui_client = get_x3ui_client(...)
        result = await x3ui_client.update_client(
            client_email=subscription.x3ui_client_email,
            enable=True,
            days=tariff.duration_days
        )
```

### 5. Добавлена функция получения истекших подписок (`utils/db.py`)

```python
async def get_all_expired_subscriptions() -> List[Subscription]:
    """Получить все истекшие подписки"""
```

Используется в `subscription_checker.py` для проверки, что все истекшие подписки отключены на сервере.

## Механика работы

### Создание новой подписки:
1. Пользователь оплачивает подписку
2. Создается клиент в 3x-ui с `expiryTime=0` (бессрочная)
3. Клиент создается с `enable=True` (включен)
4. В БД сохраняется подписка со статусом "active" и датой окончания

### Периодическая проверка (каждые 6 часов и ежедневно в 00:00):
1. Получаются все активные подписки из БД
2. Для каждой подписки:
   - Если `expire_date < текущее_время` → отключить клиента на сервере, статус → "expired"
   - Если `expire_date >= текущее_время` → включить клиента на сервере (если отключен)
3. Проверяются истекшие подписки → убеждается, что они отключены на сервере

### Продление подписки:
1. Обновляется `expire_date` в БД
2. Статус → "active"
3. Клиент включается на сервере через API
4. При необходимости обновляется `expiryTime` (хотя это не критично, т.к. управление через enable/disable)

## Преимущества новой системы

1. **Централизованное управление:** Все подписки управляются из одной БД
2. **Гибкость:** Легко продлевать, приостанавливать, возобновлять подписки
3. **Синхронизация:** Состояние в БД всегда синхронизируется с состоянием на сервере
4. **Надежность:** Периодическая проверка гарантирует, что истекшие подписки отключены
5. **Расширяемость:** Легко добавить уведомления пользователям, статистику и т.д.

## Файлы, измененные в рамках задачи

1. `services/x3ui_api.py`
   - Изменено создание клиента (expiryTime = 0)
   - Добавлены методы: `update_client`, `enable_client`, `disable_client`

2. `services/subscription_checker.py`
   - Полностью переписан для управления клиентами через API
   - Добавлена логика включения/отключения клиентов

3. `handlers/buy/payment.py`
   - Добавлена логика включения клиента при продлении подписки

4. `utils/db.py`
   - Добавлена функция `get_all_expired_subscriptions()`

## Тестирование

### Рекомендуемые проверки:

1. **Создание новой подписки:**
   - Создать подписку через бота
   - Проверить, что клиент создан в 3x-ui с `enable=True` и `expiryTime=0`
   - Проверить, что подписка в БД имеет статус "active"

2. **Периодическая проверка:**
   - Дождаться истечения подписки (или изменить `expire_date` в БД вручную)
   - Дождаться следующей проверки (или запустить вручную)
   - Проверить, что клиент отключен на сервере
   - Проверить, что статус в БД изменен на "expired"

3. **Продление подписки:**
   - Продлить истекшую подписку
   - Проверить, что клиент включен на сервере
   - Проверить, что статус в БД изменен на "active"

4. **Синхронизация:**
   - Вручную отключить клиента в 3x-ui
   - Дождаться следующей проверки
   - Проверить, что клиент снова включен (если подписка активна)

## Заключение

Реализована полноценная система управления временем подписки через API. Бот теперь полностью контролирует включение/отключение клиентов на серверах на основе данных из базы данных, что обеспечивает гибкость, надежность и централизованное управление подписками.

